<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>lensfun: Applying perspective correction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
MathJax.Hub.Config({
    messageStyle: "none"
});
</script><script type="text/javascript" src="http://lensfun.github.io/mathjax/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="lensfun-manual.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">lensfun
   &#160;<span id="projectnumber">0.3.95.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Applying perspective correction </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Perspective correction, also known as perspective control or keystone correction, corrects parallel lines. For example when taking a picture of a tower, it may be necessary to tilt the camera in order to have the whole tower in the viewframe. But then, the verticals of the tower are not parallel in the picture. Instead, the edges of the tower become narrower towards the top.</p>
<p>In general, whenever you tilt a camera relatively to a plane in your image (e.g. the front wall of a building), you get so-called “aberrant lines”, i.e., you lose the parallelity of lines (e.g. wall edges) on that plane. Moreover, circles become ellipses.</p>
<p>In some cases, such effects may be desired. In all other cases, Lensfun offers correction for them. All it needs are “control points”, i.e. points lying on lines that are supposed to be parallel. Note that in most cases, Lensfun also needs the proper focal length and crop factor for perspective correction.</p>
<p>You can use Lensfun's perspective correction in five different modes, which are distinguished by the number of control points given. This table presents an overview:</p>
<table class="doxtable">
<tr>
<th>number of<br />
control points</th><th>type</th><th>short description </th><th>focal length<br />
necessary</th><th>full<br />
correction </th></tr>
<tr>
<td>4</td><td>lines</td><td>(1) &amp; (2) define first line, (3) &amp; (4) define second line, both should be parallel </td><td>yes</td><td>no </td></tr>
<tr>
<td>5</td><td>circle</td><td>points on (distorted) circle line </td><td>yes</td><td>no </td></tr>
<tr>
<td>6</td><td>lines</td><td>(1)–(4) as with 4 control points; (5) &amp; (6) define line perpendicular to the other two </td><td>yes</td><td>yes </td></tr>
<tr>
<td>7</td><td>circle &amp; line</td><td>(1)–(5) as with 5 control points; (6) &amp; (7) define perfectly horizonal or vertical line </td><td>yes</td><td>no </td></tr>
<tr>
<td>8</td><td>lines</td><td>(1)–(6) as with 6 control points; (7) &amp; (8) define line parallel to the (5)/(6) line </td><td>no</td><td>yes </td></tr>
</table>
<p>In this table, “full correction” means that all lines that are parallel in the original (horizonal, vertical, diagonal, whatever, as long as they are within the plane) become parallel after the correction. No full correction means that only lines in <em>one</em> direction are corrected.</p>
<h1><a class="anchor" id="lines-based-pc"></a>
Lines-based correction</h1>
<div class="image-portrait43"> <div class="image">
<img src="pc-8-points.svg" alt="pc-8-points.svg"/>
<div class="caption">
8 points: two horizontals, two verticals</div></div>
</div> <div class="image-landscape"> <div class="image">
<img src="pc-6-points.svg" alt="pc-6-points.svg"/>
<div class="caption">
6 points: two verticals, one horizonal</div></div>
</div> <div class="image-landscape"> <div class="image">
<img src="pc-4-points.svg" alt="pc-4-points.svg"/>
<div class="caption">
4 points: two verticals</div></div>
</div><p>Using 4, 6, or 8 control points activates a lines-based correction using 2, 3, or 4 lines, respectively. Each consecutive pair of points defines a line. The ordering within a pair doesn't matter. In the images, you see examples for placing the control points in each case.</p>
<p>As you can see in the 8-points image, points may also share their coordinates. In the 6-points image, points 5 and 6 could be the same as 2 and 3, respectively. But try to use lines as long as possible.</p>
<p>Whether a line or a pair of lines is to be interpreted as vertical or horizontal, is decided by Lensfun by taking the best match. For example in the 8-points case, you could swap verticals and horizontals, and it would work either way.</p>
<h1><a class="anchor" id="circle-based-pc"></a>
Circle-based correction</h1>
<div class="image-landscape"> <div class="image">
<img src="pc-7-points.svg" alt="pc-7-points.svg"/>
<div class="caption">
7 points: one circle, one horizonal</div></div>
</div> <div class="image-landscape"> <div class="image">
<img src="pc-5-points.svg" alt="pc-5-points.svg"/>
<div class="caption">
5 points: one circle</div></div>
</div><p>Using 5 or 7 control points activates a circle-based correction using an ellipse which is supposed to become a circle. Mathematicaly, 5 points define an ellipse. Two additional points may be used to define a horizonal or vertical line, whichever is closer.</p>
<p>There is, unfortunately, an ambiguity to sort out: A circle may become an ellipse by tilting the camera upwards or downwards. Without further information, Lensfun cannot know what happened in a particular image. Thus, if you set the control points clockwise, Lensfun assumes that the first point is farther away from the camera than the centre of the circle. Accordingly, counter-clockwise control points indicate that the first point is closer to the camera than the centre of the circle. This may sound complicated but in most cases, the camera is tilted upwards like in the example images. Then, just set the control points clockwise beginning at the top, and it works.</p>
<h1><a class="anchor" id="pc-postprocessing"></a>
Shifting, scaling, and rotating</h1>
<p>After a successful perspective correction, it is highly senseful to apply some post-processing. Additionally to what is already in Lensfun's chain of transformations, it adds the following:</p>
<ul>
<li>
It shifts the image to that the original centre remains in the centre. In some extreme cases, the original centre cannot be displayed anymore because it is beyond the vertex. Then, the centre of the control points is used instead. </li>
<li>
It scales the image so that the centre of the image keeps its scale. </li>
<li>
It rotates the image so that lines supposed to be vertical or horizonal actually are. </li>
</ul>
<h1><a class="anchor" id="pc-d-parameter"></a>
The d parameter for fine-tuning</h1>
<div class="image">
<img src="pc-d-parameter.svg" alt="pc-d-parameter.svg"/>
<div class="caption">
Relative tilting angle for different d values</div></div>
<p> Very often, a full correction of the perspective is not the artistically best option. Instead, a slight undercorrection leads to a more pleasing result. For this and similar purposes, Lensfun offers a fine-tune parameter called “d”. It takes values from −1 to +1 with the following meaning:</p>
<table class="doxtable">
<tr>
<th>d</th><th>meaning </th></tr>
<tr>
<td>−1</td><td>no change of the image </td></tr>
<tr>
<td>0</td><td>perfect correction </td></tr>
<tr>
<td>+1</td><td>over-correction by 24% </td></tr>
</table>
<p>Technically, by increasing d from −1 to 0, the tilting angle is decreased from the original value to 0. Values of d greater than 0 increase the tilting angle to the opposite direction up to 24% of the original tilt.</p>
<h1><a class="anchor" id="pc-tips"></a>
Tips</h1>
<ul>
<li>
Use lines which are as long as possible. </li>
<li>
Use circles which are as large as possible. </li>
<li>
Take care that pairs of lines which are supposed to be parallel are as far apart as possible. </li>
<li>
Use 8 points only if the focal length is unknown or inaccurate. </li>
<li>
Do not mark lines that are already parallel in the original image. </li>
<li>
Do not mark circles that are already perfectly circular in the original image. </li>
</ul>
<h1><a class="anchor" id="pc-in-own-code"></a>
How to implement perspective correction in own code</h1>
<p>Currently, perspective correction has its own initialiser <a class="el" href="structlfModifier.html#ae058071a54086e014e38c6b35b276c11" title="Enable the perspective correction. ">lfModifier::EnablePerspectiveCorrection</a>. Typically, you will call this method immediately after <a class="el" href="structlfModifier.html#a0ce870d6f94f5a7cef5dd337ff21d643" title="Create an empty image modifier object. ">lfModifier::Create</a> and <a class="el" href="structlfModifier.html#a0d97cd8c20f05f54d79af092edca9e1a" title="Initialize the process of correcting aberrations in a image. ">lfModifier::Initialize</a>. In plain C, you call <a class="el" href="group__Correction.html#ga7f81df428113c9ec2c47ae459cc9e6cb">lf_modifier_enable_perspective_correction</a> immediately after <a class="el" href="group__Correction.html#gabf28d62b10b16f026bed4fae3fe7d9af">lf_modifier_new</a> and <a class="el" href="group__Correction.html#gabd5f4c4552abe28b24934a85070215f9">lf_modifier_initialize</a>. The only real challenge is to get the control point coordinates.</p>
<h2><a class="anchor" id="pc-coordinates"></a>
Control point coordinates</h2>
<p>Control points are given using their pixel coordinates. The origin of the coordinate system is in the top left corner, with the first pixel having the coordinates (0, 0). The first coordinate is measured to the right, and the second is measured to the bottom. For best accuracy, the coodinates do not refer to the pristine image. Instead, the following transformations need to have been applied when the coordinates are determined:</p>
<ul>
<li>
distortion correction </li>
<li>
transformation into rectilinear, if necessary </li>
</ul>
<p>Since for most lenses, both transformations don't change much, you can also use pristine RAW image coordinates lenses for simplicity, but this may lead to slightly inaccurate perspective correction, and fails for fisheyes. In contrast, the following transformations <em>must not</em> have been applied when the coordinates are determined:</p>
<ul>
<li>
scaling </li>
<li>
rotation </li>
<li>
shift </li>
<li>
crop </li>
<li>
any other coordinate-changing transformation </li>
</ul>
<p>Vignetting and TCA corrections don't matter.</p>
<h2><a class="anchor" id="pc-suggestion-for-implementation"></a>
Suggestions for getting control points</h2>
<p>If you wish to offer perspective correction in an interactive way, it is recommended to present a distortion-corrected, rectilinear image to the user. Then, the user picks coordinates in the image, and these coordinates are ready to be used for perspective correction directly.</p>
<p>Another possibility is to let the used set control points in the really pristine image (without any transformations applied). Then, you set up a modifier object only for distortion correction and – in case of a fisheye lens – for transformation into the rectilinear projection. <em>It is important that you set the “reverse” option to “true” for this modifier.</em> Then, you send the control point coordinates through <a class="el" href="structlfModifier.html#acb28d0cdf3af9cec0b1f1e2a71b159ea" title="Image correction step 2: apply the transforms on a block of pixel coordinates. ">lfModifier::ApplyGeometryDistortion</a> and get the coordinates for perspective correction. Of course, for the actual correction, you need a different modifier object. </p>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
